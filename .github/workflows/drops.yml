name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

concurrency:
  group: rust-drops-monitor
  cancel-in-progress: true

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Init state.json
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":[],"kick":[],"emptyCount":{"twitch":0,"kick":0}}' > state.json
          fi

      - name: Scrape Twitch & Kick
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          async function scrape(url, file) {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });

            // Obtener imagen del evento
            const heroImg = await page.$eval('.hero-image img', el => el.src);

            // Obtener drops
            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => {
                const img =
                  b.querySelector('video img')?.src ||
                  b.querySelector('video source')?.src?.replace('.mp4', '.jpg') ||
                  '';

                const streamers = [...b.querySelectorAll('a[href*="twitch.tv"], a[href*="kick.com"]')]
                  .map(a => ({ name: a.innerText.trim(), url: a.href }))
                  .filter(s => s.name && s.url);

                return {
                  id: b.getAttribute('href') || img,
                  name: b.querySelector('.drop-type')?.innerText || '',
                  time: b.querySelector('.drop-time span')?.innerText || '',
                  img,
                  streamers
                };
              }).filter(d => d.id)
            );

            fs.writeFileSync(file, JSON.stringify({eventImg: heroImg, drops}, null, 2));
            await browser.close();
          }

          (async () => {
            await scrape('https://twitch.facepunch.com/', 'twitch.json');
            await scrape('https://kick.facepunch.com/', 'kick.json');
          })();
          JS

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3
            URL=$4

            DATA=$(cat "$FILE")
            EVENT_IMG=$(jq -r '.eventImg' <<<"$DATA")
            CURR=$(jq -c '.drops' <<<"$DATA")
            PREV=$(jq -c ".${PLATFORM} // []" state.json)
            PREV="${PREV:-[]}"

            # Detectar nuevos drops
            NEW=$(jq -c --argjson prev "$PREV" --argjson curr "$CURR" '
              [$curr[] | select(.id as $i | $prev | map(.id) | index($i) | not)]
            ')

            COUNT=$(jq length <<<"$NEW")
            echo "DEBUG: Nuevos drops $PLATFORM: $COUNT"

            # Reset autom√°tico si no hay drops 3 veces
            if [ "$COUNT" -eq 0 ]; then
              EMPTY_COUNT=$(jq -r ".emptyCount.${PLATFORM}" state.json)
              EMPTY_COUNT=$((EMPTY_COUNT+1))
              echo "‚ÑπÔ∏è No hay drops en $PLATFORM | Contador: $EMPTY_COUNT"
              jq --argjson ec "$EMPTY_COUNT" ".emptyCount.${PLATFORM} = \$ec" state.json > tmp && mv tmp state.json
              if [ "$EMPTY_COUNT" -ge 3 ]; then
                echo "‚ö° RESET ${PLATFORM^^} CAMPAIGN"
                jq ".${PLATFORM}=[] | .emptyCount.${PLATFORM}=0" state.json > tmp && mv tmp state.json
              fi
            else
              # Reset contador
              jq ".emptyCount.${PLATFORM}=0" state.json > tmp && mv tmp state.json
            fi

            # Enviar embed del evento primero
            if [ -n "$EVENT_IMG" ]; then
              EVENT_EMBED=$(jq -n --arg t "Nuevos Drops ${PLATFORM^}" \
                --arg u "$URL" --arg img "$EVENT_IMG" --argjson c "$COLOR" \
                '{title:$t,url:$u,color:$c,image:{url:$img}}')

              curl -s -X POST -H "Content-Type: application/json" \
                --data "{\"embeds\":[$EVENT_EMBED]}" "$DISCORD_WEBHOOK"
            fi

            # Traducir drops
            translate() {
              n="$1"
              case "$n" in
                *Pickaxe*) echo "Pico";;
                *Hatchet*) echo "Hacha";;
                *Ice\ Pickaxe*) echo "Pico de hielo";;
                *Salvaged\ Icepick*) echo "Icepick recuperado";;
                *Jackhammer*) echo "Martillo neum√°tico";;
                *Hammer*) echo "Martillo";;
                *Crossbow*) echo "Ballesta";;
                *Bow*) echo "Arco";;
                *Assault\ Rifle*) echo "Rifle de asalto";;
                *Bolt\ Action\ Rifle*) echo "Rifle de cerrojo";;
                *Semi-Automatic\ Rifle*) echo "Rifle semiautom√°tico";;
                *Custom\ SMG*) echo "SMG personalizada";;
                *MP5*) echo "MP5";;
                *Thompson*) echo "Thompson";;
                *M249*) echo "M249";;
                *Revolver*) echo "Rev√≥lver";;
                *M92\ Pistol*) echo "Pistola M92";;
                *Pump\ Shotgun*) echo "Escopeta de corredera";;
                *Double\ Barrel\ Shotgun*) echo "Escopeta de doble ca√±√≥n";;
                *Handmade\ Shell*) echo "Escopeta artesanal";;
                *Rocket\ Launcher*) echo "Lanzacohetes";;
                *Waterpipe\ Shotgun*) echo "Escopeta de tuber√≠a";;
                *Grenade*) echo "Granada";;
                *Beancan\ Grenade*) echo "Granada Beancan";;
                *F1\ Grenade*) echo "Granada F1";;
                *Smoke\ Grenade*) echo "Granada de humo";;
                *Sheet\ Metal\ Door*) echo "Puerta de chapa";;
                *Armored\ Door*) echo "Puerta blindada";;
                *Garage\ Door*) echo "Puerta de garaje";;
                *Large\ Wood\ Box*) echo "Caja de madera grande";;
                *Small\ Wood\ Box*) echo "Caja de madera peque√±a";;
                *Small\ Oil\ Refinery*) echo "Peque√±a refiner√≠a de petr√≥leo";;
                *Large\ Oil\ Refinery*) echo "Gran refiner√≠a de petr√≥leo";;
                *Recycler*) echo "Recicladora";;
                *Furnace*) echo "Horno";;
                *Large\ Furnace*) echo "Horno grande";;
                *Sleeping\ Bag*) echo "Saco de dormir";;
                *Tool\ Cupboard*) echo "Armario de herramientas";;
                *Roadsign\ Helmet*) echo "Casco Roadsign";;
                *Coffee\ Can\ Helmet*) echo "Casco lata de caf√©";;
                *Metal\ Facemask*) echo "Mascarilla met√°lica";;
                *Roadsign\ Jacket*) echo "Chaqueta Roadsign";;
                *Roadsign\ Pants*) echo "Pantalones Roadsign";;
                *Hoodie*) echo "Sudadera";;
                *Pants*) echo "Pantalones";;
                *Boots*) echo "Botas";;
                *Gloves*) echo "Guantes";;
                *Chest\ Plate*) echo "Placa de pecho";;
                *Facemask*) echo "Mascarilla";;
                *Bandana*) echo "Bandana";;
                *Balaclava*) echo "Pasamonta√±as";;
                *Beanie\ Hat*) echo "Gorro";;
                *Hard\ Suit*) echo "Traje duro";;
                *Hazmat\ Suit*) echo "Traje hazmat";;
                *Wetsuit*) echo "Traje de buceo";;
                *Backpack*) echo "Mochila";;
                *Rock*) echo "Roca";;
                *Roadsign\ Kilt*) echo "Falda Roadsign";;
                *Cargo\ Pants*) echo "Pantalones cargo";;
                *Jacket*) echo "Chaqueta";;
                *Tactical\ Gloves*) echo "Guantes t√°cticos";;
                *) echo "$n";;
              esac
            }

            # Enviar drops
            jq -c '.[]' <<<"$NEW" | while read DROP; do
              NAME=$(translate "$(jq -r '.name' <<<"$DROP")")
              TIME=$(jq -r '.time' <<<"$DROP" | tr -d '\n\r' | sed 's/HOURS?/Horas/i;s/Unknown/Desconocido/i')
              IMG=$(jq -r '.img // ""' <<<"$DROP")
              [ -z "$IMG" ] && IMG="$EVENT_IMG"

              STREAMERS=$(jq -r '[.streamers[] | "["+.name+"]("+.url+")"] | join(", ")' <<<"$DROP")
              TITLE="üéÅ $NAME"
              DESC="$NAME ‚è± $TIME"
              if [ -n "$STREAMERS" ] && [ "$STREAMERS" != "[]" ]; then
                DESC="$NAME ‚è± $TIME | $STREAMERS"
              fi

              EMBED=$(jq -n \
                --arg t "$TITLE" \
                --arg d "$DESC" \
                --arg u "$URL" \
                --arg img "$IMG" \
                --argjson c "$COLOR" \
                '{title:$t,url:$u,description:$d,color:$c,image:{url:$img}}')

              curl -s -X POST -H "Content-Type: application/json" \
                --data "{\"embeds\":[$EMBED]}" "$DISCORD_WEBHOOK"
            done

            # Actualizar state.json
            jq --argjson ids "$CURR" ".${PLATFORM} = \$ids" state.json > tmp && mv tmp state.json
          }

          send_platform twitch twitch.json 9502720 https://www.twitch.tv/directory/category/rust
          send_platform kick kick.json 2003190 https://kick.facepunch.com/
          
      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git diff --quiet && exit 0
          git add state.json
          git commit -m "Update drops"
          git push || echo "Nothing to push"
