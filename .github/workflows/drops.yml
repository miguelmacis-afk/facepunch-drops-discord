name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Init state.json
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":[],"kick":[],"lastRun":0}' > state.json
          fi

      - name: 15 min lock
        run: |
          LAST=$(jq -r '.lastRun // 0' state.json)
          NOW=$(date +%s)
          if [ $((NOW - LAST)) -lt 900 ]; then
            echo "‚è±Ô∏è Lock activo: a√∫n no han pasado 15 minutos"
            exit 0
          fi

      - name: Scrape Twitch & Kick
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          async function scrape(page, url, file) {
            await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });

            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => {
                const img =
                  b.querySelector('video img')?.src ||
                  b.querySelector('video source')?.src?.replace('.mp4', '.jpg');

                const streamerLinks = [...b.querySelectorAll('a[href*="twitch.tv"], a[href*="kick.com"]')]
                  .map(a => ({
                    name: a.innerText.trim(),
                    url: a.href
                  }))
                  .filter(s => s.name && s.url);

                return {
                  id: b.getAttribute('href') || img,
                  name: b.querySelector('.drop-type')?.innerText || 'Drop',
                  time: b.querySelector('.drop-time span')?.innerText || 'Unknown',
                  img,
                  streamers: streamerLinks
                };
              }).filter(d => d.img && d.id)
            );

            fs.writeFileSync(file, JSON.stringify(drops, null, 2));
          }

          (async () => {
            const browser = await chromium.launch();
            const p1 = await browser.newPage();
            const p2 = await browser.newPage();

            await Promise.all([
              scrape(p1, 'https://twitch.facepunch.com/', 'twitch.json'),
              scrape(p2, 'https://kick.facepunch.com/', 'kick.json')
            ]);

            await browser.close();
          })();
          JS

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3
            URL=$4

            PREV=$(jq -c ".${PLATFORM} // []" state.json)
            CURR=$(jq -c '.' "$FILE")

            NEW=$(jq -c --argjson prev "$PREV" --argjson curr "$CURR" '
              [$curr[] | select(.id as $i | $prev | map(.id) | index($i) | not)]
            ')
            [ "$PREV" = "[]" ] && NEW="$CURR"

            GENERAL=$(jq -c '[.[] | select(.streamers | length == 0)]' <<<"$NEW")
            EXCLUSIVE=$(jq -c '[.[] | select(.streamers | length > 0)]' <<<"$NEW")

            send_list () {
              TYPE=$1
              LIST=$2
              TOTAL=$(jq length <<<"$LIST")
              [ "$TOTAL" -eq 0 ] && return

              i=1
              jq -c '.[]' <<<"$LIST" | while read DROP; do
                NAME=$(jq -r '.name' <<<"$DROP")
                TIME=$(jq -r '.time' <<<"$DROP")
                IMG=$(jq -r '.img' <<<"$DROP")

                # --- Evitar null ---
                NAME=${NAME:-"Drop"}
                TIME=${TIME:-"Desconocido"}

                # --- Traducciones ---
                NAME=$(echo "$NAME" | jq -Rn '
                  if test("Pickaxe";"i") then "Pico"
                  elif test("Hatchet";"i") then "Hacha"
                  elif test("Jackhammer";"i") then "Martillo neum√°tico"
                  elif test("Assault Rifle";"i") then "Rifle de asalto"
                  elif test("Bolt Action";"i") then "Rifle de cerrojo"
                  elif test("MP5";"i") then "MP5"
                  elif test("Thompson";"i") then "Thompson"
                  elif test("Crossbow";"i") then "Ballesta"
                  elif test("Garage Door";"i") then "Puerta de garaje"
                  elif test("Sheet Metal Door";"i") then "Puerta de chapa"
                  elif test("Large Wood Box";"i") then "Caja grande de madera"
                  elif test("Furnace";"i") then "Horno"
                  else . end
                ')

                TIME=$(echo "$TIME" | sed -E 's/Hours?|hours?/Horas/g; s/Unknown/Desconocido/')

                if [ "$TYPE" = "Exclusivo" ]; then
                  jq -c '.streamers[]' <<<"$DROP" | while read S; do
                    SNAME=$(jq -r '.name' <<<"$S")
                    SURL=$(jq -r '.url' <<<"$S")

                    TITLE="‚≠ê Drop Exclusivo ${PLATFORM^} | $i/$TOTAL"
                    DESC="$NAME ‚è± $TIME | Streamer: [$SNAME]($SURL)"

                    EMBED=$(jq -n --arg t "$TITLE" --arg d "$DESC" --arg u "$URL" --arg img "$IMG" --argjson c "$COLOR" \
                      '{title:$t,url:$u,description:$d,color:$c,thumbnail:{url:$img}}')

                    curl -s -X POST -H "Content-Type: application/json" \
                      --data "{\"embeds\":[$EMBED]}" "$DISCORD_WEBHOOK"
                  done
                else
                  TITLE="üéÅ Drop General ${PLATFORM^} | $i/$TOTAL"
                  DESC="$NAME ‚è± $TIME"

                  EMBED=$(jq -n --arg t "$TITLE" --arg d "$DESC" --arg u "$URL" --arg img "$IMG" --argjson c "$COLOR" \
                    '{title:$t,url:$u,description:$d,color:$c,thumbnail:{url:$img}}')

                  curl -s -X POST -H "Content-Type: application/json" \
                    --data "{\"embeds\":[$EMBED]}" "$DISCORD_WEBHOOK"
                fi

                i=$((i+1))
              done
            }

            send_list "General" "$GENERAL"
            send_list "Exclusivo" "$EXCLUSIVE"

            jq --argjson ids "$CURR" ".${PLATFORM} = \$ids" state.json > tmp && mv tmp state.json
          }

          send_platform twitch twitch.json 9502720 https://twitch.facepunch.com/
          send_platform kick kick.json 2003190 https://kick.facepunch.com/

      - name: Update lastRun
        run: |
          jq ".lastRun = $(date +%s)" state.json > tmp && mv tmp state.json

      - name: Commit state
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git diff --quiet && exit 0
          git add state.json
          git commit -m "Update drops"
          git push
