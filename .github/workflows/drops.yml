name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Initialize state.json
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":[],"kick":[]}' > state.json
          fi

      - name: Scrape Twitch Drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://twitch.facepunch.com/', { waitUntil: 'networkidle' });
            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => {
                const type = b.querySelector('.drop-type')?.innerText || 'Drop';
                const time = b.querySelector('.drop-time span')?.innerText || 'Unknown';
                const img = b.querySelector('video img')?.src || b.querySelector('video source')?.src?.replace('.mp4', '.jpg');
                let emoji = 'ðŸŽ';
                if (/pickaxe/i.test(type)) emoji = 'â›ï¸';
                else if (/hatchet/i.test(type)) emoji = 'ðŸª“';
                else if (/furnace/i.test(type)) emoji = 'ðŸ”¥';
                else if (/weapon|sar|crossbow/i.test(type)) emoji = 'ðŸ”«';
                return { name: type, time, img, emoji };
              }).filter(d => d.img)
            );
            fs.writeFileSync('twitch.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Scrape Kick Drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://kick.facepunch.com/', { waitUntil: 'networkidle' });
            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => {
                const type = b.querySelector('.drop-type')?.innerText || 'Drop';
                const time = b.querySelector('.drop-time span')?.innerText || 'Unknown';
                const img = b.querySelector('video img')?.src || b.querySelector('video source')?.src?.replace('.mp4', '.jpg');
                let emoji = 'ðŸŽ';
                if (/pickaxe/i.test(type)) emoji = 'â›ï¸';
                else if (/hatchet/i.test(type)) emoji = 'ðŸª“';
                else if (/furnace/i.test(type)) emoji = 'ðŸ”¥';
                else if (/weapon|sar|crossbow/i.test(type)) emoji = 'ðŸ”«';
                return { name: type, time, img, emoji };
              }).filter(d => d.img)
            );
            fs.writeFileSync('kick.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Notify Discord (5 drops por embed, emojis, contador)
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3
            GROUP_SIZE=5

            PREV=$(jq -c ".${PLATFORM} // []" state.json)
            CURR=$(jq -c '.' "$FILE" 2>/dev/null || echo '[]')
            PREV="${PREV:-[]}"
            CURR="${CURR:-[]}"

            # Detectar nuevos drops
            NEW=$(jq -c --argjson prev "$PREV" --argjson curr "$CURR" '
              [$curr[] | select(.img as $i | $prev | map(.img) | index($i) | not)]
            ')
            COUNT=$(jq length <<<"${NEW:-[]}")
            echo "DEBUG: Nuevos drops $PLATFORM: $COUNT"

            # Enviar todos la primera vez si state.json estÃ¡ vacÃ­o
            if [ "${PREV}" = "[]" ]; then
              echo "âš¡ EnvÃ­o inicial de todos los drops de $PLATFORM"
              NEW="$CURR"
              COUNT=$(jq length <<<"${NEW:-[]}")
            fi

            if [ "$COUNT" -eq 0 ]; then
              echo "â„¹ï¸ No hay nuevos drops en $PLATFORM"
            else
              TOTAL=$(jq length <<<"$NEW")
              EMBEDS="[]"

              for i in $(seq 0 $((TOTAL-1)) ); do
                DROP=$(jq ".[$i]" <<<"$NEW")
                IDX=$(( i % GROUP_SIZE ))

                if [ "$IDX" -eq 0 ]; then
                  THUMB=$(jq -r '.img' <<<"$DROP")
                  EMBED=$(jq -n --arg color "$COLOR" --arg thumb "$THUMB" --arg timestamp "$(date -Iseconds)" \
                    '{title:"ðŸŽ Nuevos Drops", description:"", color: ($color | tonumber), thumbnail:{url:$thumb}, footer:{text:"Rust Drops Monitor"}, timestamp:$timestamp}')
                fi

                DESC=$(jq -r '.emoji + " " + .name + " â± " + .time + "\n"' <<<"$DROP")
                EMBED=$(jq --arg desc "$DESC" '.description += $desc' <<<"$EMBED")

                if [ "$IDX" -eq $((GROUP_SIZE-1)) ] || [ "$i" -eq $((TOTAL-1)) ]; then
                  TOTAL_DROPS=$(jq length <<<"$NEW")
                  EMBED=$(jq --arg total "$TOTAL_DROPS" '.title += " | Total: " + $total' <<<"$EMBED")
                  EMBEDS=$(jq --argjson new "$EMBED" '. += [$new]' <<<"$EMBEDS")
                fi
              done

              echo "DEBUG: JSON a enviar a Discord:"
              echo "$EMBEDS" | jq .

              curl -s -X POST -H "Content-Type: application/json" --data-binary "{\"embeds\":$EMBEDS}" "$DISCORD_WEBHOOK"
            fi

            # Actualizar state.json
            jq --argjson ids "$CURR" ".${PLATFORM} = \$ids" state.json > tmp.json && mv tmp.json state.json
          }

          send_platform twitch twitch.json 0x9146FF
          send_platform kick kick.json 0x1ED760

      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git commit -m "Update state.json" || echo "No changes to commit"
          git push || echo "Nothing to push"
