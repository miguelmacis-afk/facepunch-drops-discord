name: Facepunch Drops (Visual + Count)

on:
  schedule:
    - cron: "*/20 * * * *" # cada 20 minutos
  workflow_dispatch:

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Initialize state
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":false,"kick":false}' > state.json
          fi

      - name: Fetch pages
        run: |
          curl -A "Mozilla/5.0" -s https://twitch.facepunch.com/ > twitch.html
          curl -A "Mozilla/5.0" -s https://kick.facepunch.com/ > kick.html

      - name: Extract drop images
        run: |
          extract_images() {
            FILE=$1
            grep -oP '<img[^>]+src="\K[^"]+' "$FILE" | \
            grep -Ei '\.jpg|\.jpeg|\.png|\.svg' | \
            grep -Ev 'logo|icon|banner|avatar|favicon' | \
            sort -u
          }

          extract_images twitch.html > twitch_imgs.txt
          extract_images kick.html > kick_imgs.txt

      - name: Detect activity based on images
        run: |
          if [ -s twitch_imgs.txt ]; then
            TWITCH_ACTIVE=true
          else
            TWITCH_ACTIVE=false
          fi

          if [ -s kick_imgs.txt ]; then
            KICK_ACTIVE=true
          else
            KICK_ACTIVE=false
          fi

          echo "TWITCH_ACTIVE=$TWITCH_ACTIVE" >> $GITHUB_ENV
          echo "KICK_ACTIVE=$KICK_ACTIVE" >> $GITHUB_ENV

      - name: Build embeds with images + count
        run: |
          build_embed() {
            TITLE=$1
            URL=$2
            COLOR=$3
            FILE=$4

            if [ ! -s "$FILE" ]; then
              echo ""
              return
            fi

            TOTAL=$(wc -l < "$FILE")
            DESC="Total de drops: $TOTAL\n"

            COUNT=0
            while read -r img; do
              DESC="$DESCðŸ–¼ $img\n"
              COUNT=$((COUNT+1))
              [ $COUNT -ge 8 ] && break
            done < "$FILE"

            THUMBNAIL=$(head -n 1 "$FILE")

            jq -n --arg t "$TITLE" --arg d "$DESC" --arg u "$URL" --argjson c $COLOR --arg thumb "$THUMBNAIL" '
              {
                "title": $t,
                "description": $d,
                "url": $u,
                "color": $c,
                "thumbnail": {"url": $thumb}
              }'
          }

          PREV_TWITCH=$(jq -r '.twitch|tostring' state.json)
          PREV_KICK=$(jq -r '.kick|tostring' state.json)

          TW_EMBED=null
          KI_EMBED=null

          if [ -s twitch_imgs.txt ] && [ "$PREV_TWITCH" = "false" ]; then
            TW_EMBED=$(build_embed "ðŸŽ® Twitch Drops ACTIVOS" "https://twitch.facepunch.com/" 5763719 twitch_imgs.txt)
          fi

          if [ -s kick_imgs.txt ] && [ "$PREV_KICK" = "false" ]; then
            KI_EMBED=$(build_embed "ðŸŸ¢ Kick Drops ACTIVOS" "https://kick.facepunch.com/" 3066993 kick_imgs.txt)
          fi

          [ -z "$TW_EMBED" ] && TW_EMBED=null
          [ -z "$KI_EMBED" ] && KI_EMBED=null

          jq -n --argjson t "$TW_EMBED" --argjson k "$KI_EMBED" '
            [ $t, $k ] | map(select(. != null))
          ' > embeds.json

          # Debug
          echo "DEBUG: Twitch embed:"
          echo "$TW_EMBED"
          echo "DEBUG: Kick embed:"
          echo "$KI_EMBED"
          echo "DEBUG: Final embeds.json:"
          cat embeds.json

      - name: Send Discord webhook
        run: |
          if [ "$(jq length embeds.json)" -gt 0 ]; then
            echo "Sending Discord embed..."
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"embeds\":$(cat embeds.json)}" \
              ${{ secrets.DISCORD_WEBHOOK }}
          else
            echo "No new drops to send."
          fi

      - name: Update state
        run: |
          jq -n \
            --argjson t $TWITCH_ACTIVE \
            --argjson k $KICK_ACTIVE \
            '{twitch:$t,kick:$k}' > state.json

      - name: Commit state
        run: |
          git config user.name "drops-bot"
          git config user.email "bot@github"
          git add state.json
          git commit -m "Update drops state" || echo "No changes"
          git push
