name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # Ejecuta cada 5 min, controlamos 15 min por c√≥digo

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Restore Playwright cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}

      - name: Install dependencies
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Initialize state.json
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":[],"kick":[],"lastRun":0}' > state.json
          fi

      - name: Check 15 min lock
        run: |
          LAST=$(jq -r '.lastRun // 0' state.json)
          NOW=$(date +%s)
          if [ $((NOW - LAST)) -lt 900 ]; then
            echo "‚è±Ô∏è Lock activo: a√∫n no pasaron 15 minutos"
            exit 0
          fi

      - name: Scrape Twitch Drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://twitch.facepunch.com/', { waitUntil: 'networkidle' });

            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => ({
                name: b.querySelector('.drop-type')?.innerText || 'Drop',
                time: b.querySelector('.drop-time span')?.innerText || 'Unknown',
                img: b.querySelector('video img')?.src ||
                     b.querySelector('video source')?.src?.replace('.mp4', '.jpg')
              })).filter(d => d.img)
            );

            fs.writeFileSync('twitch.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Scrape Kick Drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://kick.facepunch.com/', { waitUntil: 'networkidle' });

            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => ({
                name: b.querySelector('.drop-type')?.innerText || 'Drop',
                time: b.querySelector('.drop-time span')?.innerText || 'Unknown',
                img: b.querySelector('video img')?.src ||
                     b.querySelector('video source')?.src?.replace('.mp4', '.jpg')
              })).filter(d => d.img)
            );

            fs.writeFileSync('kick.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3
            URL=$4

            PREV=$(jq -c ".${PLATFORM} // []" state.json)
            CURR=$(jq -c '.' "$FILE" 2>/dev/null || echo '[]')

            NEW=$(jq -c --argjson prev "$PREV" --argjson curr "$CURR" '
              [$curr[] | select(.img as $i | $prev | map(.img) | index($i) | not)]
            ')

            [ "$PREV" = "[]" ] && NEW="$CURR"

            NEW_TR=$(jq -c 'map(
              .name |=
                if test("Pickaxe";"i") then "Pico"
                elif test("Hatchet";"i") then "Hacha"
                elif test("Jackhammer";"i") then "Martillo neum√°tico"
                elif test("Assault Rifle";"i") then "Rifle de asalto"
                elif test("Bolt Action";"i") then "Rifle de cerrojo"
                elif test("MP5";"i") then "MP5"
                elif test("Thompson";"i") then "Thompson"
                elif test("Crossbow";"i") then "Ballesta"
                elif test("Garage Door";"i") then "Puerta de garaje"
                elif test("Sheet Metal Door";"i") then "Puerta de chapa"
                elif test("Large Wood Box";"i") then "Caja grande de madera"
                elif test("Furnace";"i") then "Horno"
                else . end
              | .time |= sub("Hours?|hours?";"Horas";"g")
              | .time |= sub("Unknown";"Desconocido")
            )' <<<"$NEW")

            COUNT=$(jq length <<<"$NEW_TR")
            [ "$COUNT" -eq 0 ] && return

            DESC=$(jq -r 'map(.name + " ‚è± " + .time) | join("\n")' <<<"$NEW_TR")
            THUMB=$(jq -r '.[0].img' <<<"$NEW_TR")

            EMBED=$(jq -n --arg title "üéÅ Nuevos Drops ${PLATFORM^}" \
              --arg url "$URL" \
              --arg desc "$DESC" \
              --arg thumb "$THUMB" \
              --argjson color "$COLOR" \
              --arg ts "$(date -Iseconds)" \
              '{title:$title,url:$url,description:$desc,color:$color,thumbnail:{url:$thumb},timestamp:$ts}')

            curl -s -X POST -H "Content-Type: application/json" \
              --data-binary "{\"embeds\":[$EMBED]}" "$DISCORD_WEBHOOK"

            jq --argjson ids "$CURR" ".${PLATFORM} = \$ids" state.json > tmp && mv tmp state.json
          }

          send_platform twitch twitch.json 9502720 https://twitch.facepunch.com/
          send_platform kick kick.json 2003190 https://kick.facepunch.com/

      - name: Update lastRun
        run: |
          jq ".lastRun = $(date +%s)" state.json > tmp && mv tmp state.json

      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add state.json
          git commit -m "Update drops state" || true
          git push || true
