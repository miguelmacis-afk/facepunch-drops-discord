name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Load previous state
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":[],"kick":[]}' > state.json
          fi

      - name: Scrape Twitch drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://twitch.facepunch.com/', { waitUntil: 'networkidle' });

            const drops = await page.$$eval('.drop-box', boxes =>
              boxes.map(b => ({
                name: b.querySelector('.drop-type')?.innerText || 'Drop',
                time: b.querySelector('.drop-time span')?.innerText || 'Unknown',
                img: b.querySelector('img')?.src || null
              })).filter(d => d.img)
            );

            fs.writeFileSync('twitch.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Scrape Kick drops
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto('https://kick.facepunch.com/', { waitUntil: 'networkidle' });

            const drops = await page.$$eval('.drop-box', boxes =>
              boxes.map(b => ({
                name: b.querySelector('.drop-type')?.innerText || 'Drop',
                time: b.querySelector('.drop-time span')?.innerText || 'Unknown',
                img: b.querySelector('img')?.src || null
              })).filter(d => d.img)
            );

            fs.writeFileSync('kick.json', JSON.stringify(drops, null, 2));
            await browser.close();
          })();
          JS

      - name: Send Discord notifications
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3

            PREV=$(jq -r ".$PLATFORM | map(.img)" state.json)
            CURR=$(jq -r 'map(.img)' "$FILE")

            EMBEDS=$(jq -n --argjson prev "$PREV" --argjson curr "$CURR" '
              [ $curr[] | select(. as $i | $prev | index($i) | not) ]
            ')

            COUNT=$(jq length <<<"$EMBEDS")
            if [ "$COUNT" -eq 0 ]; then
              echo "â„¹ï¸ No hay nuevos drops en $PLATFORM"
              return
            fi

            jq -n --argjson drops "$EMBEDS" --arg p "$PLATFORM" --argjson c "$COLOR" '
              {
                embeds: $drops | map({
                  title: "ðŸŽ Nuevo Drop " + (.),
                  description: "Plataforma: " + $p,
                  color: $c,
                  image: { url: . }
                })
              }
            ' | curl -s -X POST -H "Content-Type: application/json" -d @- "$WEBHOOK"
          }

          send_platform twitch twitch.json 6570404
          send_platform kick kick.json 3066993

          jq -n \
            --argjson t "$(cat twitch.json)" \
            --argjson k "$(cat kick.json)" \
            '{twitch:$t,kick:$k}' > state.json

      - name: Save state
        run: |
          git config user.name "bot"
          git config user.email "bot@github"
          git add state.json
          git commit -m "update state" || true
          git push || true
