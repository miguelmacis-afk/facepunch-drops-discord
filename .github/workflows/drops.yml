name: Rust Drops Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

concurrency:
  group: rust-drops-monitor
  cancel-in-progress: true

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Init state.json
        run: |
          if [ ! -f state.json ]; then
            echo '{
              "twitch": [],
              "kick": [],
              "empty": { "twitch": 0, "kick": 0 }
            }' > state.json
          fi

      - name: Scrape Twitch & Kick
        run: |
          node <<'JS'
          const { chromium } = require('playwright');
          const fs = require('fs');

          async function scrape(url, file) {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });

            const eventImage = await page.$eval(
              'meta[property="og:image"]',
              el => el.content
            ).catch(() => null);

            const drops = await page.$$eval('a.drop-box', boxes =>
              boxes.map(b => {
                const img =
                  b.querySelector('video img')?.src ||
                  b.querySelector('video source')?.src?.replace('.mp4', '.jpg') ||
                  '';

                const streamers = [...b.querySelectorAll('a[href*="twitch.tv"], a[href*="kick.com"]')]
                  .map(a => ({ name: a.innerText.trim(), url: a.href }))
                  .filter(s => s.name && s.url);

                return {
                  id: b.getAttribute('href') || img,
                  name: b.querySelector('.drop-type')?.innerText || '',
                  time: b.querySelector('.drop-time span')?.innerText || '',
                  img,
                  streamers
                };
              }).filter(d => d.id && d.img)
            );

            fs.writeFileSync(file, JSON.stringify({ eventImage, drops }, null, 2));
            await browser.close();
          }

          (async () => {
            await scrape('https://twitch.facepunch.com/', 'twitch.json');
            await scrape('https://kick.facepunch.com/', 'kick.json');
          })();
          JS

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          send_platform () {
            PLATFORM=$1
            FILE=$2
            COLOR=$3
            URL=$4

            PREV=$(jq -c ".${PLATFORM} // []" state.json)
            EMPTY=$(jq -r ".empty.${PLATFORM}" state.json)

            EVENT_IMG=$(jq -r '.eventImage // empty' "$FILE")
            CURR=$(jq -c '.drops // []' "$FILE")

            COUNT_CURR=$(jq length <<<"$CURR")

            if [ "$COUNT_CURR" -eq 0 ]; then
              EMPTY=$((EMPTY+1))
              echo "âš ï¸ $PLATFORM sin drops ($EMPTY/2)"
            else
              EMPTY=0
            fi

            jq ".empty.${PLATFORM} = $EMPTY" state.json > tmp && mv tmp state.json

            if [ "$EMPTY" -ge 2 ]; then
              echo "â™»ï¸ Reseteando estado de $PLATFORM"
              jq ".${PLATFORM} = [] | .empty.${PLATFORM} = 0" state.json > tmp && mv tmp state.json
              PREV="[]"
            fi

            NEW=$(jq -c --argjson prev "$PREV" --argjson curr "$CURR" '
              [$curr[] | select(.id as $i | $prev | map(.id) | index($i) | not)]
            ')
            [ "$PREV" = "[]" ] && NEW="$CURR"

            TOTAL=$(jq length <<<"$NEW")
            [ "$TOTAL" -eq 0 ] && return

            LIST=$(jq -r '.[] |
              "- **" + (
                .name
                | if test("Large Wood Box";"i") then "Caja grande de madera"
                elif test("Crossbow";"i") then "Ballesta"
                elif test("Sheet Metal Door";"i") then "Puerta de chapa"
                elif test("Jackhammer";"i") then "Martillo neumÃ¡tico"
                elif test("Furnace";"i") then "Horno"
                else . end
              ) + "** â± " +
              (.time
                | gsub("HOURS?";"horas")
                | gsub("Unknown";"Desconocido")
              )
            ' <<<"$NEW")

            EMBED=$(jq -n \
              --arg t "ðŸŽ Nuevos Drops ${PLATFORM^} | Total: $TOTAL" \
              --arg d "$LIST" \
              --arg u "$URL" \
              --arg img "$EVENT_IMG" \
              --argjson c "$COLOR" \
              '{
                title:$t,
                url:$u,
                description:$d,
                color:$c,
                image:{url:$img},
                footer:{text:"Rust Drops Monitor"},
                timestamp:(now|todate)
              }')

            curl -s -X POST -H "Content-Type: application/json" \
              --data "{\"embeds\":[$EMBED]}" "$DISCORD_WEBHOOK"

            jq --argjson ids "$CURR" ".${PLATFORM} = \$ids" state.json > tmp && mv tmp state.json
          }

          send_platform twitch twitch.json 9502720 https://twitch.facepunch.com/
          send_platform kick kick.json 3066993 https://kick.facepunch.com/

      - name: Commit state.json
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git diff --quiet && exit 0
          git add state.json
          git commit -m "Update drops state"
          git push
