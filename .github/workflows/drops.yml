name: Facepunch Drops Bot

on:
  schedule:
    - cron: "*/20 * * * *" # cada 20 minutos
  workflow_dispatch:

jobs:
  drops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install

      - name: Scrape Twitch Drops
        run: |
          node <<'JS'
const { chromium } = require('playwright');
const fs = require('fs');

(async () => {
  const browser = await chromium.launch();
  const page = await browser.newPage();
  await page.goto('https://twitch.facepunch.com/');
  await page.waitForLoadState('networkidle');

  const imgs = await page.$$eval('img', imgs => imgs.map(i => i.src)
    .filter(src => /\.(jpg|jpeg|png|svg)$/i.test(src) && !/logo|icon|banner|avatar|favicon/i.test(src))
  );

  fs.writeFileSync('twitch_imgs.txt', imgs.join('\n'));
  await browser.close();
})();
JS

      - name: Scrape Kick Drops
        run: |
          node <<'JS'
const { chromium } = require('playwright');
const fs = require('fs');

(async () => {
  const browser = await chromium.launch();
  const page = await browser.newPage();
  await page.goto('https://kick.facepunch.com/');
  await page.waitForLoadState('networkidle');

  const imgs = await page.$$eval('img', imgs => imgs.map(i => i.src)
    .filter(src => /\.(jpg|jpeg|png|svg)$/i.test(src) && !/logo|icon|banner|avatar|favicon/i.test(src))
  );

  fs.writeFileSync('kick_imgs.txt', imgs.join('\n'));
  await browser.close();
})();
JS

      - name: Detect activity
        run: |
          if [ ! -f state.json ]; then
            echo '{"twitch":false,"kick":false}' > state.json
          fi

          if [ -s twitch_imgs.txt ]; then
            TWITCH_ACTIVE=true
          else
            TWITCH_ACTIVE=false
          fi

          if [ -s kick_imgs.txt ]; then
            KICK_ACTIVE=true
          else
            KICK_ACTIVE=false
          fi

          echo "TWITCH_ACTIVE=$TWITCH_ACTIVE" >> $GITHUB_ENV
          echo "KICK_ACTIVE=$KICK_ACTIVE" >> $GITHUB_ENV

      - name: Build embeds and send to Discord
        run: |
          build_embed() {
            TITLE=$1
            URL=$2
            COLOR=$3
            FILE=$4

            if [ ! -s "$FILE" ]; then
              echo ""
              return
            fi

            TOTAL=$(wc -l < "$FILE")
            DESC="Total de drops: $TOTAL\n"

            COUNT=0
            while read -r img; do
              DESC="$DESCðŸ–¼ $img\n"
              COUNT=$((COUNT+1))
              [ $COUNT -ge 8 ] && break
            done < "$FILE"

            THUMBNAIL=$(head -n 1 "$FILE")

            jq -n --arg t "$TITLE" --arg d "$DESC" --arg u "$URL" --argjson c $COLOR --arg thumb "$THUMBNAIL" '
              {
                "title": $t,
                "description": $d,
                "url": $u,
                "color": $c,
                "thumbnail": {"url": $thumb}
              }'
          }

          PREV_TWITCH=$(jq -r '.twitch|tostring' state.json)
          PREV_KICK=$(jq -r '.kick|tostring' state.json)

          TW_EMBED=null
          KI_EMBED=null

          if [ -s twitch_imgs.txt ] && [ "$PREV_TWITCH" = "false" ]; then
            TW_EMBED=$(build_embed "ðŸŽ® Twitch Drops ACTIVOS" "https://twitch.facepunch.com/" 5763719 twitch_imgs.txt)
          fi

          if [ -s kick_imgs.txt ] && [ "$PREV_KICK" = "false" ]; then
            KI_EMBED=$(build_embed "ðŸŸ¢ Kick Drops ACTIVOS" "https://kick.facepunch.com/" 3066993 kick_imgs.txt)
          fi

          [ -z "$TW_EMBED" ] && TW_EMBED=null
          [ -z "$KI_EMBED" ] && KI_EMBED=null

          jq -n --argjson t "$TW_EMBED" --argjson k "$KI_EMBED" '
            [ $t, $k ] | map(select(. != null))
          ' > embeds.json

          if [ "$(jq length embeds.json)" -gt 0 ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"embeds\":$(cat embeds.json)}" \
              ${{ secrets.DISCORD_WEBHOOK }}
          fi

      - name: Update state
        run: |
          jq -n \
            --argjson t $TWITCH_ACTIVE \
            --argjson k $KICK_ACTIVE \
            '{twitch:$t,kick:$k}' > state.json

      - name: Commit state
        run: |
          git config user.name "drops-bot"
          git config user.email "bot@github"
          git add state.json
          git commit -m "Update drops state" || echo "No changes"
          git push
